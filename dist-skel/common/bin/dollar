#!/bin/bash
set -eu
cd "$(dirname $0)/.." &> /dev/null
export DOLLAR_HOME=$(pwd)
export PATH=$PATH:${DOLLAR_HOME}/jdk/jre/bin
export DOLLAR_VERSION=$(cat RELEASE)
if [[ "$OSTYPE" == "linux-gnu" ]]; then
       os=linux
elif [[ "$OSTYPE" == "darwin"* ]]; then
       os=macosx
elif [[ "$OSTYPE" == "cygwin" ]]; then
       echo "Unsupported operating system $OSTYPE would you consider porting this simple script?" && exit 1
elif [[ "$OSTYPE" == "msys" ]]; then
       echo "Unsupported operating system $OSTYPE would you consider porting this simple script?" && exit 1
elif [[ "$OSTYPE" == "win32" ]]; then
       echo "Unsupported operating system $OSTYPE would you consider porting this simple script?" && exit 1
elif [[ "$OSTYPE" == "freebsd"* ]]; then
       echo "Unsupported operating system $OSTYPE would you consider porting this simple script?" && exit 1
else
       echo "Unsupported operating system $OSTYPE would you consider porting this simple script?" && exit 1
fi

if ! javac -version
then
    echo "Downloading a valid Java 1.8 JDK for OS type: ${os}"
    echo
    echo "Use of the JDK is under the terms of:"
    echo
    echo "     http://www.azulsystems.com/products/zulu/terms-of-use"
    echo "     and http://openjdk.java.net/legal/"
    echo
    echo
    echo "If you do not agree, please delete the contents of"
    echo "${DOLLAR_HOME} and ${HOME}/.dollar-cache"
    echo
    echo "This may take some time, but hey you only need to do it once."
    echo ""
        [ -d ~/.dollar-cache ] || mkdir ~/.dollar-cache
    if [[ $os == "macosx" ]]
    then
        durl=http://cdn.azul.com/zulu/bin/zulu8.21.0.1-jdk8.0.131-macosx_x64.zip
        [ -f ~/.dollar-cache/jdk.zip ] || curl -L ${durl}  > ~/.dollar-cache/jdk.zip
        unzip -q ~/.dollar-cache/jdk.zip -d .
    fi
    if [[ $os == "linux" ]]
    then
        durl=http://cdn.azul.com/zulu/bin/zulu8.21.0.1-jdk8.0.131-linux_x64.tar.gz
        [ -f ~/.dollar-cache/jdk.tgz ] || curl -L ${durl}  > ~/.dollar-cache/jdk.tgz
        tar -zxvf ~/.dollar-cache/jdk.tgz
    fi
    mv zulu* jdk
fi
cd -  &> /dev/null
export JAVA_HOME=${DOLLAR_HOME}/jdk/
if [ $# -ne 1 ]
then
    echo "Dollar v${DOLLAR_VERSION}"
    echo "Usage: dollar <filename>.ds"
    exit 1
fi
java -classpath "${DOLLAR_HOME}/lib/*:${DOLLAR_HOME}/ext:${DOLLAR_HOME}/plugins/*:${HOME}/.dollar/lib" com.sillelien.dollar.main.ParserMain $@
